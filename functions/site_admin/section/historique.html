<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historique - JPO MMI</title>
    <link rel="stylesheet" href="../assets/css/points_style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Historique des Points</h1>
            <p id="membreInfo">Chargement...</p>
        </div>

        <!-- Messages -->
        <div id="successMessage" class="success-message hidden"></div>
        <div id="errorMessage" class="error-message hidden"></div>
        <div id="loading" class="loading hidden">Chargement...</div>

        <!-- Bouton retour -->
        <div class="card">
            <a href="page_membre.html" class="btn btn-secondary" style="text-decoration: none; display: block; text-align: center;">
                ‚Üê Retour √† l'ajout de points
            </a>
        </div>

        <!-- Liste des transactions -->
        <div class="card">
            <h2>Derni√®res transactions</h2>
            <div id="historiqueList" class="historique-list">
                <!-- Les transactions seront charg√©es ici -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = '../api/points_api.php';
        let currentMembre = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadMembreFromSession();
            loadHistorique();
        });

        // Charger le membre (simulation)
        function loadMembreFromSession() {
            currentMembre = {
                id_membre: 1,
                nom: 'Dupont',
                prenom: 'Marie',
                nom_stand: 'Stand Cr√©a'
            };
            
            document.getElementById('membreInfo').textContent = 
                `${currentMembre.prenom} ${currentMembre.nom} - ${currentMembre.nom_stand}`;
        }

        // Charger l'historique
        async function loadHistorique() {
            if (!currentMembre) return;
            
            showLoading();
            
            try {
                const response = await fetch(
                    `${API_URL}?action=historique&id_membre=${currentMembre.id_membre}&limit=20`
                );
                const result = await response.json();
                
                hideLoading();
                
                if (result.success && result.data) {
                    displayHistorique(result.data);
                } else {
                    showError('Erreur lors du chargement');
                }
            } catch (error) {
                hideLoading();
                showError('Erreur de connexion: ' + error.message);
            }
        }

        // Afficher l'historique
        function displayHistorique(transactions) {
            const container = document.getElementById('historiqueList');
            
            if (transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Aucune transaction pour le moment</p>';
                return;
            }
            
            container.innerHTML = transactions.map(t => `
                <div class="transaction-item">
                    <div class="header-row">
                        <span class="name">${t.prenom || ''} ${t.nom || 'Anonyme'}</span>
                        <span class="points">+${t.points} pts</span>
                    </div>
                    <div class="date">
                        ${formatDate(t.date_ajout)}
                        ${t.modifie ? ' (Modifi√©)' : ''}
                    </div>
                    <div class="actions">
                        <button class="btn-small btn-edit" onclick="modifierTransaction(${t.id_transaction}, ${t.points})">
                            ‚úèÔ∏è Modifier
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Modifier une transaction
        async function modifierTransaction(idTransaction, pointsActuels) {
            const nouveauxPoints = prompt(
                `Points actuels: ${pointsActuels}\nNouveau nombre de points:`,
                pointsActuels
            );
            
            if (!nouveauxPoints || nouveauxPoints === pointsActuels.toString()) {
                return;
            }
            
            const points = parseInt(nouveauxPoints);
            if (isNaN(points) || points < 0) {
                showError('Nombre de points invalide');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${API_URL}?action=modifier_points`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_transaction: idTransaction,
                        nouveaux_points: points
                    })
                });
                
                const result = await response.json();
                
                hideLoading();
                
                if (result.success) {
                    showSuccess('Points modifi√©s avec succ√®s!');
                    setTimeout(() => loadHistorique(), 1000);
                } else {
                    showError('Erreur lors de la modification');
                }
            } catch (error) {
                hideLoading();
                showError('Erreur de connexion: ' + error.message);
            }
        }

        // Formater la date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('fr-FR', options);
        }

        // Messages et loading
        function showSuccess(message) {
            const div = document.getElementById('successMessage');
            div.textContent = message;
            div.classList.remove('hidden');
            setTimeout(() => div.classList.add('hidden'), 3000);
        }

        function showError(message) {
            const div = document.getElementById('errorMessage');
            div.textContent = message;
            div.classList.remove('hidden');
            setTimeout(() => div.classList.add('hidden'), 3000);
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
    </script>
</body>
</html>
